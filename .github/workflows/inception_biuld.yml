name: Inception CI

on:
  push:
    branches: [ main ]
    paths:
      - 'srcs/**'
      - 'docker-compose.yml'
      - '.github/workflows/inception_biuld.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'srcs/**'
      - 'docker-compose.yml'
      - '.github/workflows/inception_biuld.yml'

concurrency:
  group: nginx-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nginx-only:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      COMPOSE_FILE: docker-compose.yml

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set nginx
        run: |
          docker compose build nginx wordpress

      - name: Start containers
        run: |
          docker compose up -d nginx wordpress

      - name: List containers
        run: |
            docker ps --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

      - name: Aguardar php-fpm (porta 9000 no container wordpress)
        run: |
          set -e
          ATTEMPTS=30
          SLEEP=3
          echo "Aguardando php-fpm (wordpress:9000) ..."
          for i in $(seq 1 $ATTEMPTS); do
            if docker exec wordpress sh -c "ss -tlpn 2>/dev/null | grep -q ':9000'"; then
              echo "php-fpm ouvindo na porta 9000."
              exit 0
            fi
            echo "Tentativa $i/$ATTEMPTS - ainda não escutando."
            sleep $SLEEP
          done
          echo "Falha: php-fpm não escutou na porta 9000 a tempo."
          docker compose logs wordpress || true
          exit 1

      - name: Validar php-fpm config
        run: |
          set -e
          docker exec wordpress sh -c "php-fpm -t || php-fpm8.2 -t"

      - name: Test Port 443 (HTTPS)
        run: |
          set -e
          ATTEMPTS=25
          SLEEP=3
          echo "Aguardando HTTPS em https://localhost ..."
          for i in $(seq 1 $ATTEMPTS); do
            CODE=$(curl -sk -o /dev/null -w '%{http_code}' https://localhost/ || true)
            if echo "$CODE" | grep -Eq '^(200|301|302)$'; then
              echo "OK: HTTP $CODE"
              exit 0
            fi
            echo "Tentativa $i/$ATTEMPTS código=$CODE"
            docker compose ps nginx
            sleep $SLEEP
          done
          echo "FALHA: não obteve resposta aceitável."
          docker compose logs nginx || true
          docker exec nginx ss -tlpn || true
          exit 1

      - name: Verificar processo e porta dentro do container
        run: |
          docker exec nginx ss -tlpn
          docker exec nginx nginx -t

      - name: Logs (sucesso)
        if: success()
        run: docker compose logs --no-color nginx

      - name: Teardown
        if: always()
        run: docker compose down -v
